#Declare Screens
<MyScreenManager>:
    id:screen_manager
    name:"screen_manager"
    MainScreen:
        name:"GUI"
        manager:screen_manager
    ProgressScreen:
        id:ProgressScreen
        name:"ProgressScreen"
        manager:screen_manager
    AdvancedScreen:
        name:"AdvancedScreen"
        manager:screen_manager
    FileOpen:
        name:"FileOpen"
        manager:screen_manager
    Outdir:
        name:"Outdir"
        manager:screen_manager
    ResultsScreen:
        name:"ResultsScreen"
        manager:screen_manager
        total_min:ProgressScreen.total_min
        frame_count:ProgressScreen.frame_count
    ErrorScreen:
        name:"ErrorScreen"
        manager:screen_manager
    
<MainScreen>:
    BoxLayout:
        orientation:'vertical'
        Label:
            text:"DeepMeerkat V0.0.1"
            font_size:25
        BoxLayout:
            BoxLayout:
                orientation:'horizontal'
                Button:
                    text:"Help"
                    on_press: root.help_site()   
                Button:
                    text:"Advanced settings"
                    on_press: root.gotoAdvanced(app.root)
        Button:
            text:"Choose input"
            font_size:25
            on_press:root.gotoFileOpen(app.root)
        Button:
            text:"Choose output directory"
            font_size:25
            on_press:root.gotoOutdir(app.root)
        Label:
            size_hint_x:0.75
            text: "[b]Input:[/b] " + app.input_file
            markup: True
            font_size:15
        Label:
            size_hint_x:0.75
            text: "[b]Output:[/b] " + app.output_file
            markup: True
            font_size:15
        Button: 
            text:"Run"
            font_size:45
            size_hint:(1,0.8)
            on_release:root.run_press(app.root)
<FileOpen>:
    name:"FileOpen"
    BoxLayout:
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            dirselect:"True"
            on_selection: text_input.text = self.selection and self.selection[0] or ''
            size_hint_y:1.5
        Label:
            text: "Select above or type path below"
            size_hint_y:0.25
        TextInput:
            size_hint_y:0.4
            text_input: text_input
            on_text:app.input_file=str(text_input.text)
            id: text_input
            font_size: 30
            multiline: False
    BoxLayout:
        size_hint_y: None
        height: 30
        Button:
            text: "Cancel"
            on_release: root.gotoMain(app.root)
        Button:
            text: "Select"
            on_release: app.MM.args.input=text_input.text; root.gotoMain(app.root)
<Outdir>:
    name:"Outdir"
    BoxLayout:
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            dirselect:"True"
            on_selection: text_input.text = self.selection and self.selection[0] or ''
            size_hint_y:1.5
        Label:
            text: "Select above or type path below"
            size_hint_y:0.25
        TextInput:
            size_hint_y:0.4
            text_input: text_input
            on_text:app.input_file=str(text_input.text)
            id: text_input
            font_size: 30
            multiline: False
    BoxLayout:
        size_hint_y: None
        height: 30
        Button:
            text: "Cancel"
            on_release: root.gotoMain(app.root)
        Button:
            text: "Select"
            on_release: app.MM.args.input=text_input.text; root.gotoMain(app.root)
            
<AdvancedScreen>
    on_enter:app.MM.mode='advanced'
    BoxLayout:
        orientation:'vertical'
        Button:
            text: "Back"
            size_hint:(0.2,.3)
            pos_hint:{'top':0}
            on_press:root.gotoMain(app.root)
        BoxLayout:
            Label:
                text: "Draw Motion Objects"
            CheckBox:
                active: False
                on_active:app.MM.todraw=self.active
        BoxLayout:
            Label:
                text: "Multithreaded"
            CheckBox:
                active: True
                on_active:app.MM.args.threaded=self.active
        Label:
            text:"Path to tensorflow model"
        TextInput:
            text:str(app.MM.args.path_to_model)
            on_text: app.MM.args.path_to_model=self.text
            font_size:20
            multiline:False
        Button:
            text:"Run"
            font_size:40
            size_hint:(1,0.6)
            on_release:root.run_press(app.root)

<ProgressScreen>
    on_pre_enter:root.assignname(app.MM)
    on_enter: root.MotionM(app.MM)
    on_waitflag: if self.waitflag==1: root.manager.current="ResultsScreen"
    on_errorflag: if self.errorflag==1: root.gotoErrorScreen(app.root)

    BoxLayout:
        orientation:'vertical'
        BoxLayout:
            size_hint:(1,1)
            pos_hint:{'center_y':1}
            orientation:'vertical'
            Label:
                text: "[b]TensorFlow Status:[/b] "
                markup: True
                font_size:20
            Label:
                text: "[b]Running File:[/b] " + str(app.MM.args.input)
                markup: True
                font_size:20
            Label:
                text: "[b]Output Directory:[/b] " + str(app.MM.args.output)
                markup: True
                font_size:20
        BoxLayout:
            size_hint:(0.9,1)
            
            Label:
                text: 'Progress'
                size_hint:(0.25,1)
                font_size:20
            ProgressBar:
                id:pb
                value: 0
                size_hint:(0.8,1)
                                          
<ResultsScreen>
    BoxLayout:
        orientation:'vertical'
        Button:
            text: "Restart"
            size_hint:(0.2,.3)
            pos_hint:{'top':0}
            on_press:root.gotoMain(app.root)
        Label:
            text: "[b]Input File:[/b] " + str(app.MM.args.input)
            markup: True
            font_size:20
        Label:
            text: "[b]Output Directory:[/b] " + str(app.MM.args.output)
            markup: True
            font_size:20
        Label:
            text: "[b]Run time:[/b] " + str(round(root.total_min,2)) + " min"
            markup: True
            font_size:20
        Label:
            text: str(root.len_annotations) + " candidate motion frames " + "from " #+ str(root.frame_count) + " images (" + str(round(root.len_annotations/root.frame_count,3)*100) + "%)"
            font_size:20
        Button:
            text: "More statistics and parameter information"
            size_hint:(1,0.5)
            on_press: root.openfile(app.MM)   

<ErrorScreen>
    on_enter:root.getMessage(app.root)
    BoxLayout:
        orientation:'vertical'
        Button:
            text:"Restart"
            on_press:root.gotoMain(app.root)
            size_hint:(0.25,0.4)
        Label:
            text: "Error occurred!"
            font_size:20
        TextInput:
            id:"emessage'
            text: root.em
            size_hint:(1,2)
        Button:
            text: "Parameter Log"
            size_hint:(1,0.5)
            on_press: root.openfile(app.MM)           
        Label:
            text: "If you believe this is a bug, submit the parameter log,\na copy of your error, and a description of your video to the link below."            
        Button:
            text: "Send Error Report"
            on_press: root.help_issue()
            size_hint:(1,0.5)

    